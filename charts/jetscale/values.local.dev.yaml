global:
  env: "local-dev"

# Local Dev inner-loop (Tilt):
# - Build images locally (Tilt `docker_build`)
# - live_update on source changes
# - No GHCR pulls required

# 1. DATABASE
postgres:
  enabled: true
  image: "postgres:15-alpine"
  auth:
    username: "jetscale_backend"
    password: "jetscale_backend"
    database: "jetscale"
  persistence:
    size: 1Gi

# 2. REDIS
redis:
  enabled: true
  image: "redis:7-bullseye"

externalSecret:
  enabled: false # Master switch - disables SecretStore + all ExternalSecrets for local dev
  app:
    enabled: false

# 3. BACKEND API (Dev Image + Hot Reload)
backend-api:
  enabled: true
  fullnameOverride: "jetscale-local-backend-api"
  serviceAccount:
    create: true
    name: "jetscale-service-account"
  image:
    repository: localhost:5000/backend-dev
    tag: "tilt"
    pullPolicy: Always
  imagePullSecrets: []
  command: ["./entrypoint.sh"]
  args: ["python3", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
  envFrom: null
  # Init container to set up database schema and seed admin user
  initContainer:
    name: setup-db
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e
        echo "‚è≥ Waiting for PostgreSQL server to be ready..."
        set +e
        until python3 -c "
        import asyncio
        import asyncpg
        import os
        import sys

        async def check_server():
            try:
                db_host = os.getenv('JETSCALE_DB_HOST', '')
                db_port = os.getenv('JETSCALE_DB_PORT', '5432')
                db_user = os.getenv('JETSCALE_DB_USER', '')
                db_password = os.getenv('JETSCALE_DB_PASSWORD', '')
                db_name = os.getenv('JETSCALE_DB_NAME', 'postgres')

                if not all([db_host, db_user, db_password]):
                    print('‚ùå Database connection environment variables not set')
                    return False

                conn = await asyncpg.connect(
                    host=db_host,
                    port=int(db_port),
                    user=db_user,
                    password=db_password,
                    database=db_name,
                    ssl='prefer',
                )
                await conn.close()
                print('‚úÖ PostgreSQL server is ready')
                return True
            except Exception as exc:
                print(f'‚ùå PostgreSQL server not ready: {exc}')
                return False

        sys.exit(0 if asyncio.run(check_server()) else 1)
        "
        do
          echo "‚è≥ PostgreSQL not ready, waiting 5 seconds..."
          sleep 5
        done
        set -e

        echo "üîß Running database setup..."
        python3 setup_db.py
        echo "üì¶ Loading fixtures..."
        python3 load_fixtures.py
        echo "‚úÖ Database initialization complete"
  # Relaxed probes for local development
  livenessProbe:
    httpGet:
      path: /api/v2/system/live
      port: 8000
    initialDelaySeconds: 60
    periodSeconds: 60
    timeoutSeconds: 10
    failureThreshold: 5
  readinessProbe:
    httpGet:
      path: /api/v2/system/ready
      port: 8000
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 5
  # Mount Backend .env file from ConfigMap (created by Tiltfile)
  volumes:
    - name: backend-env
      configMap:
        name: backend-env-file
  volumeMounts:
    - name: backend-env
      mountPath: /app/.env
      subPath: .env
  env:
    JETSCALE_APP_NAME: "JetScale Backend (Tilt)"
    JETSCALE_DEBUG: "true"
    # Parity: ExternalSecret is disabled in local dev; auth requires a JWT signing key.
    # This is a dev-only default (NOT a production secret).
    JETSCALE_JWT_SECRET_KEY: "tilt-local-jwt-secret"
    JETSCALE_DB_HOST: "jetscale-local-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale_backend"
    JETSCALE_DB_PASSWORD: "jetscale_backend"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale_backend:jetscale_backend@jetscale-local-postgres:5432/jetscale"
    JETSCALE_REDIS_HOST: "jetscale-local-redis-master"
    JETSCALE_REDIS_PORT: "6379"
    JETSCALE_REDIS_DB: "0"
    JETSCALE_AWS_REGION: "us-east-1"
    # Dev-only admin credentials (NOT for production use)
    JETSCALE_DEFAULT_ADMIN_EMAIL: "devops@jetscale.ai"
    JETSCALE_DEFAULT_ADMIN_USERNAME: "admin"
    JETSCALE_DEFAULT_ADMIN_PASSWORD: "njPhTFWWrwoTG7gKHBiY"
    PYTHONDONTWRITEBYTECODE: "1"
    PYTHONUNBUFFERED: "1"
  # Background Jobs Configuration
  cronJobs: null

# 4. BACKEND WS (Dev Image + Hot Reload)
backend-ws:
  enabled: true
  fullnameOverride: "jetscale-local-backend-ws"
  serviceAccount:
    create: false
    name: "jetscale-service-account"
  service:
    port: 8001
    portName: websocket
  image:
    repository: localhost:5000/backend-dev
    tag: "tilt"
    pullPolicy: Always
  imagePullSecrets: []
  command: ["./entrypoint.sh"]
  args: ["python3", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001", "--reload"]
  envFrom: null
  # Relaxed probes for local development
  livenessProbe:
    httpGet:
      path: /api/v1/ws/health
      port: 8001
    initialDelaySeconds: 60
    periodSeconds: 60
    timeoutSeconds: 10
    failureThreshold: 5
  readinessProbe:
    httpGet:
      path: /api/v1/ws/health
      port: 8001
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 5
  # Mount Backend .env file from ConfigMap (created by Tiltfile)
  volumes:
    - name: backend-env
      configMap:
        name: backend-env-file
  volumeMounts:
    - name: backend-env
      mountPath: /app/.env
      subPath: .env
  env:
    JETSCALE_APP_NAME: "JetScale Backend WS (Tilt)"
    JETSCALE_DEBUG: "true"
    # Parity: ExternalSecret is disabled in local dev; auth requires a JWT signing key.
    # This is a dev-only default (NOT a production secret).
    JETSCALE_JWT_SECRET_KEY: "tilt-local-jwt-secret"
    JETSCALE_DB_HOST: "jetscale-local-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale_backend"
    JETSCALE_DB_PASSWORD: "jetscale_backend"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale_backend:jetscale_backend@jetscale-local-postgres:5432/jetscale"
    JETSCALE_REDIS_HOST: "jetscale-local-redis-master"
    JETSCALE_REDIS_PORT: "6379"
    JETSCALE_REDIS_DB: "0"
    JETSCALE_AWS_REGION: "us-east-1"
    # Dev-only admin credentials (NOT for production use)
    JETSCALE_DEFAULT_ADMIN_EMAIL: "devops@jetscale.ai"
    JETSCALE_DEFAULT_ADMIN_USERNAME: "admin"
    JETSCALE_DEFAULT_ADMIN_PASSWORD: "njPhTFWWrwoTG7gKHBiY"
    PYTHONDONTWRITEBYTECODE: "1"
    PYTHONUNBUFFERED: "1"

# 5. FRONTEND WEB (Dev Image)
frontend:
  image:
    repository: localhost:5000/frontend-dev
    tag: "tilt"
    pullPolicy: Always
  imagePullSecrets: []
  containerPort: 3000
  service:
    port: 3000
  resources:
    requests:
      memory: "512Mi"
      cpu: "200m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  env:
    NODE_ENV: "development"
    HOST: "0.0.0.0"
    PORT: "3000"
    VITE_API_BASE_URL: "http://jetscale-local-backend-api:8000"
  command: ["pnpm"]
  args: ["start"]
  livenessProbe: null
  readinessProbe: null

ingress:
  enabled: false

appConfigMap:
  enabled: false
