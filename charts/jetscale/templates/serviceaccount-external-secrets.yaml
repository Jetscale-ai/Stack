{{/*
ServiceAccount for External Secrets (IRSA)

This ServiceAccount is used by SecretStore to authenticate with AWS Secrets Manager.
The IRSA role ARN is provided via values and annotated on the ServiceAccount.

Contract with IaC:
- IaC creates IAM role with wildcard namespace trust: system:serviceaccount:*:*-external-secrets
- Stack creates ServiceAccount with name: {{ .Release.Name }}-external-secrets

Note: This is also a pre-install hook because the db-bootstrap Job (weight -10)
needs this ServiceAccount to exist. We use weight -20 to ensure creation order.
The hook-delete-policy keeps the SA around for normal operation after install.
*/}}
{{- if .Values.externalSecret.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ .Release.Name }}-external-secrets
  labels:
    {{- include "jetscale.labels" . | nindent 4 }}
    app.kubernetes.io/component: external-secrets
  annotations:
    # Pre-install hook to support db-bootstrap Job (which runs at weight -10)
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-20"
    # Keep the resource after hook completes (needed for normal operation)
    "helm.sh/resource-policy": keep
    {{- if .Values.externalSecret.irsaRoleArn }}
    eks.amazonaws.com/role-arn: {{ .Values.externalSecret.irsaRoleArn }}
    {{- end }}
{{- end }}
