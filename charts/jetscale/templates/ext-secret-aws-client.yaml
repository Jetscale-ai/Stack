{{/*
ExternalSecret for AWS Client Credentials

Fetches cross-account assume-role credentials from AWS Secrets Manager.
Used by discover-aws CronJob to discover resources in client AWS accounts.

Contract with IaC:
- IaC creates secret at: ${project_name}/application/aws/client
- Secret contains: JETSCALE_CLIENT_AWS_REGION, JETSCALE_CLIENT_AWS_ROLE_ARN, JETSCALE_CLIENT_AWS_ROLE_EXTERNAL_ID
*/}}
{{- if and .Values.externalSecret.enabled .Values.externalSecret.awsClient.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Release.Name }}-aws-client-secret
  labels:
    {{- include "jetscale.labels" . | nindent 4 }}
    app.kubernetes.io/component: application
spec:
  refreshInterval: {{ .Values.externalSecret.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Release.Name }}-secrets-store
    kind: SecretStore
  target:
    name: {{ .Release.Name }}-aws-client-secret
    creationPolicy: Owner
    deletionPolicy: Delete
    template:
      type: Opaque
      data:
        JETSCALE_CLIENT_AWS_REGION: "{{`{{ .region }}`}}"
        JETSCALE_CLIENT_AWS_ROLE_ARN: "{{`{{ .role_arn }}`}}"
        JETSCALE_CLIENT_AWS_ROLE_EXTERNAL_ID: "{{`{{ .external_id }}`}}"
  data:
    - secretKey: region
      remoteRef:
        key: {{ .Values.externalSecret.awsClient.secretPath | default (printf "%s/application/aws/client" .Values.global.project_name) }}
        property: JETSCALE_CLIENT_AWS_REGION
    - secretKey: role_arn
      remoteRef:
        key: {{ .Values.externalSecret.awsClient.secretPath | default (printf "%s/application/aws/client" .Values.global.project_name) }}
        property: JETSCALE_CLIENT_AWS_ROLE_ARN
    - secretKey: external_id
      remoteRef:
        key: {{ .Values.externalSecret.awsClient.secretPath | default (printf "%s/application/aws/client" .Values.global.project_name) }}
        property: JETSCALE_CLIENT_AWS_ROLE_EXTERNAL_ID
{{- end }}
