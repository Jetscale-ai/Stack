{{- if .Values.externalSecret.app.enabled }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $.Release.Name }}-app-secrets
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: "{{ .Values.global.client_name }}-secrets-store-{{ .Values.global.env }}"
    kind: SecretStore
  target:
    name: {{ $.Release.Name }}-app-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # NOTE:
        # - Source secret is snake_case keys (matches existing staging convention).
        # - Pods expect env vars with `JETSCALE_` prefix (see backend `config.py` env_prefix).
        # - Do NOT transform values (passwords/URLs are case-sensitive).
        JETSCALE_ANTHROPIC_API_KEY: "{{ .anthropic_api_key }}"
        JETSCALE_AWS_ACCESS_KEY_ID: "{{ .aws_access_key_id }}"
        JETSCALE_AWS_SECRET_ACCESS_KEY: "{{ .aws_secret_access_key }}"
        JETSCALE_JWT_SECRET_KEY: "{{ .jwt_secret_key }}"
        JETSCALE_DEFAULT_ADMIN_EMAIL: "{{ .admin_email }}"
        JETSCALE_DEFAULT_ADMIN_PASSWORD: "{{ .admin_password }}"
        JETSCALE_LANGFUSE_SECRET_KEY: "{{ .langfuse_secret_key }}"
        JETSCALE_LANGFUSE_PUBLIC_KEY: "{{ .langfuse_public_key }}"
        JETSCALE_LANGFUSE_HOST: "{{ .langfuse_host }}"
        JETSCALE_ENABLE_LANGFUSE: "{{ .enable_langfuse }}"
        JETSCALE_RECOMMENDATION_AGENT_ROLE_ARN: "{{ .recommendation_agent_role_arn }}"
        JETSCALE_PLANNER_MODEL_NAME: "{{ .planner_model_name }}"
        JETSCALE_PLANNER_TEMPERATURE: "{{ .planner_temperature }}"
        JETSCALE_PLANNER_MAX_TOKENS: "{{ .planner_max_tokens }}"
        JETSCALE_PLANNER_TIMEOUT: "{{ .planner_timeout }}"
        JETSCALE_PLANNER_DEBUG_MODE: "{{ .planner_debug_mode }}"
        JETSCALE_RECOMMENDATION_MODEL_NAME: "{{ .recommendation_model_name }}"
        JETSCALE_RECOMMENDATION_TEMPERATURE: "{{ .recommendation_temperature }}"

        # Email configuration (AWS SES)
        # IMPORTANT: Do NOT set SMTP host/port/tls/ssl here; those are provided via ConfigMap
        # (`jetscale-config`) to avoid envFrom ordering collisions.
        JETSCALE_SMTP_USERNAME: "{{ .smtp_username }}"
        JETSCALE_SMTP_PASSWORD: "{{ .smtp_password }}"
        JETSCALE_FRONTEND_URL: "{{ .frontend_url }}"
        JETSCALE_EMAIL_FROM: "{{ .email_from }}"
        JETSCALE_EMAIL_FROM_NAME: "{{ .email_from_name }}"
        JETSCALE_VERIFICATION_TOKEN_EXPIRE_MINUTES: "{{ (.verification_token_expire_minutes | default 30) | toString }}"
        JETSCALE_MAX_VERIFICATION_ATTEMPTS: "{{ (.max_verification_attempts | default 5) | toString }}"
        JETSCALE_EMAIL_RATE_LIMIT_PER_HOUR: "{{ (.email_rate_limit_per_hour | default 3) | toString }}"
        JETSCALE_IP_RATE_LIMIT_PER_HOUR: "{{ (.ip_rate_limit_per_hour | default 10) | toString }}"
        JETSCALE_VERIFICATION_RATE_LIMIT_PER_HOUR: "{{ (.verification_rate_limit_per_hour | default 5) | toString }}"
        JETSCALE_ENABLE_ENUMERATION_PROTECTION: "{{ (.enable_enumeration_protection | default true) | toString }}"

        # Cron job knobs
        JETSCALE_CRON_API_URL: "{{ .cron_api_url }}"
        JETSCALE_CRON_REFRESH_DAYS: "{{ (.cron_refresh_days | default 1) | toString }}"
        JETSCALE_CRON_BATCH_SIZE: "{{ (.cron_batch_size | default 10) | toString }}"
        JETSCALE_CRON_RETRY_FAILED: "{{ (.cron_retry_failed | default true) | toString }}"
        JETSCALE_CRON_ENABLE_ALERTS: "{{ (.cron_enable_alerts | default false) | toString }}"
        JETSCALE_CRON_ALERT_ON_ERROR_THRESHOLD: "{{ (.cron_alert_on_error_threshold | default 0) | toString }}"
        JETSCALE_CRON_ALERT_EMAILS: "{{ (.cron_alert_emails | default "") | toString }}"
  data:
  - secretKey: anthropic_api_key
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: anthropic_api_key
  - secretKey: aws_access_key_id
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: aws_access_key_id
  - secretKey: aws_secret_access_key
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: aws_secret_access_key
  - secretKey: jwt_secret_key
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: jwt_secret_key
  - secretKey: admin_email
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: admin_email
  - secretKey: admin_password
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: admin_password
  - secretKey: langfuse_secret_key
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: langfuse_secret_key
  - secretKey: langfuse_public_key
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: langfuse_public_key
  - secretKey: langfuse_host
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: langfuse_host
  - secretKey: enable_langfuse
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: enable_langfuse
  - secretKey: recommendation_agent_role_arn
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: recommendation_agent_role_arn
  - secretKey: planner_model_name
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: planner_model_name
  - secretKey: planner_temperature
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: planner_temperature
  - secretKey: planner_max_tokens
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: planner_max_tokens
  - secretKey: planner_timeout
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: planner_timeout
  - secretKey: planner_debug_mode
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: planner_debug_mode
  - secretKey: recommendation_model_name
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: recommendation_model_name
  - secretKey: recommendation_temperature
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: recommendation_temperature

  # Email configuration
  - secretKey: smtp_username
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: smtp_username
  - secretKey: smtp_password
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: smtp_password
  - secretKey: frontend_url
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: frontend_url
  - secretKey: email_from
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: email_from
  - secretKey: email_from_name
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: email_from_name
  - secretKey: verification_token_expire_minutes
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: verification_token_expire_minutes
  - secretKey: max_verification_attempts
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: max_verification_attempts
  - secretKey: email_rate_limit_per_hour
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: email_rate_limit_per_hour
  - secretKey: ip_rate_limit_per_hour
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: ip_rate_limit_per_hour
  - secretKey: verification_rate_limit_per_hour
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: verification_rate_limit_per_hour
  - secretKey: enable_enumeration_protection
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: enable_enumeration_protection

  # Cron job knobs
  - secretKey: cron_api_url
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_api_url
  - secretKey: cron_refresh_days
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_refresh_days
  - secretKey: cron_batch_size
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_batch_size
  - secretKey: cron_retry_failed
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_retry_failed
  - secretKey: cron_enable_alerts
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_enable_alerts
  - secretKey: cron_alert_on_error_threshold
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_alert_on_error_threshold
  - secretKey: cron_alert_emails
    remoteRef:
      key: "{{ .Values.global.client_name }}-{{ .Values.global.env }}/application/config"
      property: cron_alert_emails
{{- end }}
