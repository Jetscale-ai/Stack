{{- if .Values.appConfigMap.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $.Release.Name }}-config
  labels:
    {{- include "jetscale.labels" $ | nindent 4 }}
data:
  # Application Configuration
  JETSCALE_HOST: "0.0.0.0"
  JETSCALE_PORT: "8000"
  JETSCALE_DEBUG: "false"
  JETSCALE_ENVIRONMENT: {{ .Values.appConfigMap.environment | default "RELEASE" }}

  # Database Configuration (External Secrets will provide missing values)
  JETSCALE_DB_PORT: "5432"

  # Agent Configuration
  JETSCALE_PLANNER_MODEL_NAME: "claude-sonnet-4-20250514"
  JETSCALE_PLANNER_TEMPERATURE: "0.1"
  JETSCALE_PLANNER_MAX_TOKENS: "4000"
  JETSCALE_PLANNER_TIMEOUT: "60"
  JETSCALE_PLANNER_DEBUG_MODE: "false"
  JETSCALE_RECOMMENDATION_MODEL_NAME: "claude-sonnet-4-5-20250929"
  JETSCALE_RECOMMENDATION_TEMPERATURE: "0.1"

  # Performance Configuration
  JETSCALE_MAX_CONCURRENT_RECOMMENDATIONS: "3"  # Reduced from 5 to match dev environment
  JETSCALE_EVENTBUS_WORKERS: "5"
  JETSCALE_EVENTBUS_MAX_QUEUE_SIZE: "500"
  JETSCALE_EVENTBUS_RESULT_TTL: "3600"
  JETSCALE_EVENTBUS_MAX_RESULTS: "1000"
  JETSCALE_API_TIMEOUT: "60"
  JETSCALE_MAX_RETRIES: "3"

  # Python Configuration
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"

  # Proxy Configuration - Trust forwarded headers from nginx/ALB
  FORWARDED_ALLOW_IPS: "*"
  FORWARDED_ALLOW_HOSTS: "*"
  ROOT_PATH: ""
  PROXY_HEADERS_TIMEOUT: "5"
  USE_X_FORWARDED_HOST: "true"
  USE_X_FORWARDED_PORT: "true"
  USE_X_FORWARDED_PREFIX: "true"

  # CORS Configuration (Allow HTTPS domain and localhost)
  JETSCALE_CORS_ALLOWED_ORIGINS: "{{ include "jetscale.corsAllowedOrigins" . }}"
  JETSCALE_CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
  JETSCALE_CORS_ALLOWED_HEADERS: "Content-Type,Authorization,X-Requested-With"

  # Data Directory
  JETSCALE_DATA_DIR: "/app/data"

  # Cron Job Configuration
  JETSCALE_CRON_BATCH_SIZE: "10"

  # AWS Configuration
  AWS_DEFAULT_REGION: "us-east-1"

  # Email/SMTP Configuration (sensitive values from External Secrets)
  # Provide non-secret SMTP defaults via ConfigMap so the app can start even if
  # the ExternalSecret projection is temporarily empty/stale.
  JETSCALE_SMTP_SERVER: "email-smtp.us-east-1.amazonaws.com"
  JETSCALE_SMTP_PORT: "587"
  JETSCALE_SMTP_TLS: "true"
  JETSCALE_SMTP_SSL: "false"
  JETSCALE_FRONTEND_URL: "{{ include "jetscale.frontendUrl" . }}"
  JETSCALE_EMAIL_FROM: "noreply@jetscale.ai"
  JETSCALE_EMAIL_FROM_NAME: "JetScale"
  JETSCALE_VERIFICATION_TOKEN_EXPIRE_MINUTES: "30"
  JETSCALE_MAX_VERIFICATION_ATTEMPTS: "5"
  JETSCALE_EMAIL_RATE_LIMIT_PER_HOUR: "3"
  JETSCALE_IP_RATE_LIMIT_PER_HOUR: "10"
  JETSCALE_VERIFICATION_RATE_LIMIT_PER_HOUR: "5"
  JETSCALE_ENABLE_ENUMERATION_PROTECTION: "true"

  # Observability Configuration
  JETSCALE_ENABLE_LANGFUSE: "true"
  JETSCALE_LANGFUSE_HOST: "https://us.cloud.langfuse.com"
{{- end }}
