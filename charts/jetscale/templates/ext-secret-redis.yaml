{{/*
ExternalSecret for Redis Credentials (Optional)

Fetches Redis endpoint from AWS Secrets Manager when using AWS ElastiCache.
Only created when redis is disabled (using AWS-managed Redis) and externalSecret.redis.enabled is true.

Contract with IaC:
- IaC creates secret at: jetscale-prod/application/backend/redis
- Secret contains: redis-endpoint (array with address)
*/}}
{{- if and .Values.externalSecret.enabled .Values.externalSecret.redis.enabled (not .Values.redis.enabled) }}
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Release.Name }}-redis-secret
  labels:
    {{- include "jetscale.labels" . | nindent 4 }}
    app.kubernetes.io/component: redis
spec:
  refreshInterval: {{ .Values.externalSecret.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Release.Name }}-secrets-store
    kind: SecretStore
  target:
    name: {{ .Release.Name }}-redis-secret
    creationPolicy: Owner
    deletionPolicy: Delete
    template:
      type: Opaque
      data:
        JETSCALE_REDIS_HOST: "{{`{{ .endpoint }}`}}"
        JETSCALE_REDIS_SSL: "true"
  data:
    - secretKey: endpoint
      remoteRef:
        key: {{ .Values.externalSecret.awsSecretPrefix }}/application/backend/redis
        property: redis-endpoint.0.address
{{- end }}
