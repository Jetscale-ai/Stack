# ==========================================================
# JETSCALE STACK - DEFAULT INTERFACE
# ==========================================================
global:
  env: "production"
  # Used for parity with Jetscale-IaC naming conventions and external entrypoints.
  # Example: "jetscale" (live), "pr-123" (ephemeral)
  client_name: ""
  # tenant_id: ""

appConfigMap:
  enabled: true
externalSecret:
  app:
    enabled: true
    
# ----------------------------------------------------------
# 1. CORE SERVICES
# ----------------------------------------------------------
backend-api:
  enabled: true
  replicaCount: 1
  image:
    pullPolicy: IfNotPresent
  resources:
    requests:
      memory: "768Mi"
      cpu: "200m"
    limits:
      memory: "2.5Gi"  # Increased from 1.5Gi to prevent OOM during batch recommendation processing with agents
      cpu: "1000m"     # Increased from 500m for parallel agent processing (50 EventBus workers)
  livenessProbe:
    httpGet:
      path: /api/v2/system/live
      port: 8000
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
  readinessProbe:
    httpGet:
      path: /api/v2/system/ready
      port: 8000
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
  env:
    JETSCALE_COMPONENT: "api"
  volumes:
  - name: jetscale-data
    emptyDir: {}
  - name: jetscale-logs
    emptyDir: {}
  volumeMounts:
  - name: jetscale-data
    mountPath: /app/data
  - name: jetscale-logs
    mountPath: /app/logs
  initContainer:
    name: setup-db
    command: ["/bin/sh", "-c"]
    args:
    - |
      echo "ðŸ”§ Running database setup..."
      python3 setup_db.py
      echo "ðŸ“¦ Loading fixtures..."
      python3 load_fixtures.py
      echo "âœ… Database initialization complete"
    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "200m"
  # Background Jobs Configuration
  cronJobs:
    pull-coh:
      schedule: "30 2 * * *"
      command: ["python3", "jobs/aws/action_pull_coh.py"]
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "300m"
    pull-co:
      schedule: "45 2 * * *"
      command: ["python3", "jobs/aws/action_pull_co.py"]
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "300m"
    discover-aws:
      schedule: "0 3 * * *"
      activeDeadlineSeconds: 1800
      command: ["python3", "jobs/aws/discover_aws_resources.py"]
      resources:
        requests:
          memory: "512Mi"
          cpu: "200m"
        limits:
          memory: "1Gi"
          cpu: "500m"
    generate-from-coh:
      suspend: true  # Suspended by default - enable per client as needed
      schedule: "30 2 * * *"
      command: ["python3", "jobs/aws/generate_custom_reco_from_coh.py"]
      activeDeadlineSeconds: 1800
      resources:
        requests:
          memory: "512Mi"
          cpu: "200m"
        limits:
          memory: "1Gi"
          cpu: "500m"
    generate-from-discovery:
      schedule: "30 3 * * *"
      activeDeadlineSeconds: 1800
      command: ["python3", "jobs/aws/generate_custom_reco_from_discovery.py"]
      resources:
        requests:
          memory: "512Mi"
          cpu: "200m"
        limits:
          memory: "1Gi"
          cpu: "500m"
    pull-ce:
      schedule: "45 3 * * *"
      command: ["python3", "jobs/aws/action_pull_ce.py"]
      resources:
        requests:
          memory: "256Mi"
          cpu: "100m"
        limits:
          memory: "512Mi"
          cpu: "300m"

backend-ws:
  enabled: true
  args:
  - |
    echo "ðŸš€ Starting JetScale WebSocket with correct database configuration..."
    echo "Using database: $JETSCALE_DB_NAME"
    python3 -m uvicorn main:app --host 0.0.0.0 --port 8001 --proxy-headers --forwarded-allow-ips="*"
  env:
    JETSCALE_COMPONENT: "websocket"
  service:
    port: 8001
    portName: websocket
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "250m"
  livenessProbe:
    httpGet:
      path: /api/v2/system/ws/live
      port: 8001
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
  readinessProbe:
    httpGet:
      path: /api/v2/system/ws/ready
      port: 8001
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
  volumes:
  - name: jetscale-logs
    emptyDir: {}
  - name: websocket-entrypoint #Temp - should be moved to the Dockerfile
    configMap:
      name: websocket-entrypoint
      defaultMode: 0755
  volumeMounts:
  - name: jetscale-logs
    mountPath: /app/logs
  - name: websocket-entrypoint
    mountPath: /app/entrypoint.sh
    subPath: entrypoint.sh
  file_configmaps: #Temp - should be moved to the Dockerfile
  # ConfigMap exact name (for other mount ref.) => file path to the base of the chart
    websocket-entrypoint: "files/entrypoint.sh"

frontend:
  enabled: true
  replicaCount: 1
  image:
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 128Mi

# ----------------------------------------------------------
# 2. INFRASTRUCTURE (Custom Definitions)
# ----------------------------------------------------------
postgres:
  enabled: false
  image: "postgres:15-alpine"
  auth:
    username: "jetscale"
    database: "jetscale"
    password: "change-me"
  # Schema must match infrastructure.yaml (Flat)
  persistence:
    enabled: true
    size: 8Gi

redis:
  enabled: false
  image: "redis:7-bullseye"
  auth:
    enabled: false

# ----------------------------------------------------------
# 3. ROUTING
# ----------------------------------------------------------
# This block is for setting up the ingress for more information can be found here: https://kubernetes.io/docs/concepts/services-networking/ingress/
ingress:
  enabled: true
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts: {}
    # chart-example.local:
    #   - path: /
    #     pathType: ImplementationSpecific
    #     serviceNameSuffix: frontend
    #     servicePortNumber: 80
    #   - path: /api
    #     pathType: ImplementationSpecific
    #     serviceNameSuffix: backend-api
    #     servicePortNumber: 8000
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

# -- Expose the service via gateway-api HTTPRoute
# Requires Gateway API resources and suitable controller installed within the cluster
# (see: https://gateway-api.sigs.k8s.io/guides/)
httpRoute:
  # HTTPRoute enabled.
  enabled: false
  # HTTPRoute annotations.
  annotations: {}
  # Which Gateways this Route is attached to.
  parentRefs:
  - name: gateway
    sectionName: http
    # namespace: default
  # Hostnames matching HTTP header.
  hostnames:
  - chart-example.local
  # List of rules and filters applied.
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /headers
    serviceNameSuffix: backend-api
    servicePortNumber: 8000
  #   filters:
  #   - type: RequestHeaderModifier
  #     requestHeaderModifier:
  #       set:
  #       - name: My-Overwrite-Header
  #         value: this-is-the-only-value
  #       remove:
  #       - User-Agent
  # - matches:
  #   - path:
  #       type: PathPrefix
  #       value: /echo
  #     headers:
  #     - name: version
  #       value: v2