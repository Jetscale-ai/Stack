# ==========================================================
# TEST BASE CONFIGURATION
# Shared by: values.test.ci.yaml, values.test.local.yaml,
#            values.test.local.ci.yaml
# ==========================================================

# 1. DATABASE (Ephemeral for Tests)
postgres:
  enabled: true
  image: "postgres:15-alpine"
  auth:
    username: "jetscale-user"
    password: "jetscale-password"
    database: "jetscale"
  persistence:
    enabled: false
    size: 1Gi

# 2. REDIS
redis:
  enabled: true
  image: "redis:7-bullseye"

# 3. SECRETS (Disabled for tests; using Env Vars)
externalSecret:
  app:
    enabled: false

# 4. BACKEND API
backend-api:
  enabled: true
  replicaCount: 1
  serviceAccount:
    create: true
    name: "jetscale-service-account"
  envFrom: {}
  initContainer:
    name: setup-db
    command: ["/bin/sh", "-c"]
    args:
      - |
        set -e
        echo "‚è≥ Waiting for PostgreSQL server to be ready..."
        set +e
        until python3 -c "
        import asyncio
        import asyncpg
        import os
        import sys

        async def check_server():
            try:
                db_host = os.getenv('JETSCALE_DB_HOST', '')
                db_port = os.getenv('JETSCALE_DB_PORT', '5432')
                db_user = os.getenv('JETSCALE_DB_USER', '')
                db_password = os.getenv('JETSCALE_DB_PASSWORD', '')
                db_name = os.getenv('JETSCALE_DB_NAME', 'postgres')

                if not all([db_host, db_user, db_password]):
                    print('‚ùå Database connection environment variables not set')
                    return False

                conn = await asyncpg.connect(
                    host=db_host,
                    port=int(db_port),
                    user=db_user,
                    password=db_password,
                    database=db_name,
                    ssl='prefer',
                )
                await conn.close()
                print('‚úÖ PostgreSQL server is ready')
                return True
            except Exception as exc:
                print(f'‚ùå PostgreSQL server not ready: {exc}')
                return False

        sys.exit(0 if asyncio.run(check_server()) else 1)
        "
        do
          echo "‚è≥ PostgreSQL not ready, waiting 5 seconds..."
          sleep 5
        done
        set -e

        echo "üîß Running database setup..."
        python3 setup_db.py
        echo "üì¶ Loading fixtures..."
        python3 load_fixtures.py
        echo "‚úÖ Database initialization complete"
  env:
    JETSCALE_DEBUG: "false"
    JETSCALE_AWS_REGION: "us-east-1"
    JETSCALE_DB_HOST: "jetscale-ci-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale-user"
    JETSCALE_DB_PASSWORD: "jetscale-password"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale-user:jetscale-password@jetscale-ci-postgres:5432/jetscale"
    JETSCALE_REDIS_HOST: jetscale-ci-redis-master
    # Test-only admin credentials (NOT for production use)
    JETSCALE_DEFAULT_ADMIN_EMAIL: "admin@ci.example.com"
    JETSCALE_DEFAULT_ADMIN_USERNAME: "admin"
    JETSCALE_DEFAULT_ADMIN_PASSWORD: "ci-admin-password"

# 5. BACKEND WS
backend-ws:
  enabled: true
  replicaCount: 1
  serviceAccount:
    create: false
    name: "jetscale-service-account"
  envFrom: {}
  env:
    JETSCALE_DEBUG: "true"
    JETSCALE_AWS_REGION: "us-east-1"
    JETSCALE_DB_HOST: "jetscale-ci-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale-user"
    JETSCALE_DB_PASSWORD: "jetscale-password"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale-user:jetscale-password@jetscale-ci-postgres:5432/jetscale"
    JETSCALE_REDIS_HOST: jetscale-ci-redis-master
    PYTHONDONTWRITEBYTECODE: "1"
    PYTHONUNBUFFERED: "1"

# 6. FRONTEND
frontend:
  enabled: true
  replicaCount: 1
  env:
    VITE_API_BASE_URL: "http://jetscale-ci-backend:8000"

# 7. ROUTING (Disabled for tests)
ingress:
  enabled: false
appConfigMap:
  enabled: true

# Create placeholder secrets so backend envFrom references resolve in tests.
testSecrets:
  enabled: true
