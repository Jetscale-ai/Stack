# ==========================================================
# KIND CI (GitHub Actions Runner)
# Self-contained deployment for `mage test:ci` on Kind.
# ==========================================================
global:
  env: "ci-kind"

# 1. DATABASE (in-cluster)
postgres:
  enabled: true
  image: "postgres:15-alpine"
  auth:
    username: "jetscale-user"
    password: "jetscale-password"
    database: "jetscale"
  # Avoid depending on a storage class in ephemeral CI clusters.
  persistence:
    enabled: false
    size: 1Gi

# 2. REDIS (in-cluster)
redis:
  enabled: true
  image: "redis:7-bullseye"

externalSecret:
  app:
    enabled: false

# 3. BACKEND API (remote OCI image, wired to in-cluster DB/Redis)
backend-api:
  enabled: true
  replicaCount: 1
  serviceAccount:
    create: true
    name: "jetscale-service-account"
  imagePullSecrets:
    - name: regcred
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "4.1.2"
    pullPolicy: Always
  envFrom: null
  env:
    JETSCALE_APP_NAME: "JetScale Backend (CI)"
    JETSCALE_DEBUG: "false"
    # CI Kind: ExternalSecret is disabled; auth requires a JWT signing key.
    JETSCALE_JWT_SECRET_KEY: "ci-kind-jwt-secret"
    # Required by backend bootstrap (admin user initialization)
    # Use a real TLD; EmailStr rejects `.local` as reserved.
    JETSCALE_DEFAULT_ADMIN_EMAIL: "admin@ci.example.com"
    JETSCALE_DEFAULT_ADMIN_USERNAME: "admin"
    JETSCALE_DEFAULT_ADMIN_PASSWORD: "ci-admin-password"
    # Required by backend entrypoint bootstrap (explicit host/user/password checks)
    JETSCALE_DB_HOST: "jetscale-ci-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale-user"
    JETSCALE_DB_PASSWORD: "jetscale-password"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale-user:jetscale-password@jetscale-ci-postgres:5432/jetscale"
    # JETSCALE_REDIS_URL: "redis://jetscale-ci-redis-master:6379/0"
    JETSCALE_REDIS_HOST: jetscale-ci-redis-master
    JETSCALE_AWS_REGION: "us-east-1"

# 4. BACKEND WS
backend-ws:
  serviceAccount:
    create: false
    name: "jetscale-service-account"
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "4.1.2"
    pullPolicy: Always
  imagePullSecrets:
    - name: regcred
  # service:
  #   type: NodePort
  #   port: 8001
  #   nodePort: 30001
  # command: ["python3", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
  envFrom: null
  env:
    JETSCALE_APP_NAME: "JetScale Backend (CI)"
    JETSCALE_DEBUG: "true"
    # CI Kind: ExternalSecret is disabled; auth requires a JWT signing key.
    JETSCALE_JWT_SECRET_KEY: "ci-kind-jwt-secret"
    # Required by backend entrypoint bootstrap (explicit host/user/password checks)
    JETSCALE_DB_HOST: "jetscale-ci-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale-user"
    JETSCALE_DB_PASSWORD: "jetscale-password"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale-user:jetscale-password@jetscale-ci-postgres:5432/jetscale"
    # JETSCALE_REDIS_URL: "redis://jetscale-ci-redis-master:6379/0"
    JETSCALE_REDIS_HOST: jetscale-ci-redis-master
    JETSCALE_AWS_REGION: "us-east-1"
    PYTHONDONTWRITEBYTECODE: "1"
    PYTHONUNBUFFERED: "1"

# 5. FRONTEND WEB (remote OCI image)
frontend:
  enabled: true
  replicaCount: 1
  imagePullSecrets:
    - name: regcred
  image:
    repository: ghcr.io/jetscale-ai/frontend
    tag: "2.4.0"
    pullPolicy: Always
  env:
    VITE_API_BASE_URL: "http://jetscale-ci-backend:8000"

# 5. ROUTING (not needed for CI; tests port-forward backend service)
ingress:
  enabled: false
appConfigMap:
  enabled: false