---
# Source: jetscale/charts/backend-ws/templates/cm-files.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: websocket-entrypoint
  labels:
    helm.sh/chart: backend-ws-2.0.3
    app.kubernetes.io/name: backend-ws
    app.kubernetes.io/instance: test
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
data:
  entrypoint.sh: |
    #!/bin/bash
    set -e
    
    echo "üöÄ Starting JetScale WebSocket Server..."
    
    # Wait for database to be ready
    echo "‚è≥ Waiting for database connection..."
    until python3 -c "
    import asyncio
    import asyncpg
    import os
    import sys
    
    async def check_db():
        try:
            db_host = os.getenv('JETSCALE_DB_HOST', '')
            db_port = os.getenv('JETSCALE_DB_PORT', '5432')
            db_user = os.getenv('JETSCALE_DB_USER', '')
            db_password = os.getenv('JETSCALE_DB_PASSWORD', '')
            db_name = os.getenv('JETSCALE_DB_NAME', 'jetscale')
            
            if not all([db_host, db_user, db_password]):
                print('‚ùå Database environment variables not set')
                return False
            
            conn = await asyncpg.connect(
                host=db_host,
                port=int(db_port),
                user=db_user,
                password=db_password,
                database=db_name,
                ssl='require'
            )
            await conn.close()
            print('‚úÖ Database connection successful')
            return True
        except Exception as e:
            print(f'‚ùå Database not ready: {e}')
            return False
    
    if not asyncio.run(check_db()):
        sys.exit(1)
    "; do
        echo "‚è≥ Database not ready, waiting 5 seconds..."
        sleep 5
    done
    
    echo "‚úÖ Database is ready, starting WebSocket server..."
    
    # Start the WebSocket server
    exec python3 -c "
    import uvicorn
    import os
    from main import app
    
    # Set component for websocket mode
    os.environ['JETSCALE_COMPONENT'] = 'websocket'
    
    uvicorn.run(
        app,
        host='0.0.0.0',
        port=8001,
        log_level=os.getenv('JETSCALE_LOG_LEVEL', 'info').lower(),
        access_log=True
    )
    "
