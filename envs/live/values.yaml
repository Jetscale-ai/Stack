# ==========================================================
# LIVE ENVIRONMENT (EKS) â€” console.jetscale.ai
# ==========================================================
global:
  # Align with Jetscale-IaC `clients/variables/jetscale.tfvars`
  env: "prod"
  client_name: "jetscale"
  tenant_id: "jetscale-console"

# 1. INFRA (Managed by Terraform in AWS)
postgres:
  enabled: false

redis:
  enabled: false

# 2. BACKEND
backend-api:
  enabled: true
  replicaCount: 3
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "1.2.3"

  # CRITICAL: Sticky sessions for EventBus/WebSockets when scaling >1 replica
  service:
    type: ClusterIP
    port: 8000
    sessionAffinity: ClientIP
    sessionAffinityConfig:
      clientIP:
        timeoutSeconds: 10800

  # Production schedule
  cronJobs:
    - name: discovery
      schedule: "0 */4 * * *"
      command: ["python3", "jobs/aws/discover_aws_resources.py"]
    - name: pull-coh
      schedule: "30 */6 * * *"
      command: ["python3", "jobs/aws/action_pull_coh.py"]
    - name: pull-co
      schedule: "45 */12 * * *"
      command: ["python3", "jobs/aws/action_pull_co.py"]

  # Prefer Terraform-managed ESO targets (Jetscale-IaC creates these Secrets)
  externalSecrets:
    enabled: false

  envFrom:
    - secretRef:
        name: "jetscale-db-secret"
    - secretRef:
        name: "jetscale-redis-secret"
    - secretRef:
        name: "jetscale-common-secrets"
    - secretRef:
        name: "jetscale-aws-client-secret"
  devMode:
    enabled: false
  resources:
    requests:
      cpu: "1000m"
      memory: "1Gi"
    limits:
      cpu: "2000m"
      memory: "2Gi"

# 3. FRONTEND
frontend-web:
  enabled: true
  replicaCount: 3
  image:
    repository: ghcr.io/jetscale-ai/frontend
    tag: "2.0.4"
  env:
    # This should point at the same host the Ingress serves for /api
    VITE_API_BASE_URL: "https://console.jetscale.ai"

# 4. ROUTING
ingress:
  enabled: true
  className: "alb"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    # Ensure ALB stickiness matches K8s Service stickiness
    alb.ingress.kubernetes.io/target-group-attributes: stickiness.enabled=true,stickiness.lb_cookie.duration_seconds=10800
  hosts:
    - host: "console.jetscale.ai"
      paths:
        - path: /api
          pathType: Prefix
        - path: /
          pathType: Prefix

# 5. EXTERNAL ENTRYPOINT (for Terraform DNS discovery)
apiExternal:
  enabled: true
