# ==========================================================
# PREVIEW ENVIRONMENT (Ephemeral EKS + AWS Infra)
# ==========================================================
global:
  # Overridden by CI (e.g., pr-123)
  env: "ephemeral"
  client_name: "ephemeral" # overwritten by workflow

# 1. INFRA (Managed by Terraform in AWS)
postgres:
  enabled: false

redis:
  enabled: false

# 2a. BACKEND-API
backend-api:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "4.6.2" # Match live (known-good)
    pullPolicy: Always

  # NOTE: Secret names are tenant-specific (e.g., pr-123-db-secret).
  # The workflow injects the correct envFrom refs via `--set`.
  envFrom: {}

  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"

  env:
    JETSCALE_AWS_REGION: "us-east-1"
    # DB/Redis/JWT are injected via envFrom Secrets
  # Preview safety: suspend background CronJobs in ephemeral/preview environments.
  # (Must remain a map type to avoid Helm coalesce warnings.)
  cronJobs:
    pull-coh:
      suspend: true
    pull-co:
      suspend: true
    discover-aws:
      suspend: true
    generate-from-coh:
      suspend: true
    generate-from-discovery:
      suspend: true

# 2b. BACKEND-WS
backend-ws:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "4.6.2" # Match live (known-good)
    pullPolicy: Always

  # NOTE: Secret names are tenant-specific (e.g., pr-123-db-secret).
  # The workflow injects the correct envFrom refs via `--set`.
  envFrom: {}

  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"

  env:
    JETSCALE_AWS_REGION: "us-east-1"
    # DB/Redis/JWT are injected via envFrom Secrets
  cronJobs: {}

# 3. FRONTEND
frontend:
  enabled: true
  image:
    repository: ghcr.io/jetscale-ai/frontend
    tag: "2.7.1" # Overridden by CI if needed
  env:
    # The workflow injects the correct host (e.g., https://pr-123.jetscale.ai)
    VITE_API_BASE_URL: "https://preview.jetscale.ai"

# 4. ROUTING
ingress:
  annotations:
    # Wildcard cert for *.jetscale.ai in the Live AWS account (us-east-1)
    alb.ingress.kubernetes.io/certificate-arn: "arn:aws:acm:us-east-1:134051052096:certificate/6e3e7f72-af8e-457d-a397-8f13728dd06c"
  hosts:
    # Explicit empty list: use `envs/aws.yaml` `ingressHostDefaultPaths`
    # (avoids YAML null edge-cases across Helm/YAML versions).
    preview.jetscale.ai: []
