# ==========================================================
# PREVIEW ENVIRONMENT (Ephemeral EKS + AWS Infra)
# ==========================================================
global:
  env: "preview" # Overridden by CI (e.g., "pr-123")
  tenant_id: "preview" # Overridden by CI

# 1. INFRASTRUCTURE (Managed by Terraform)
# Disable in-cluster stateful sets; we use AWS RDS/Redis.
postgres:
  enabled: false

redis:
  enabled: false

# 2. BACKEND
backend-api:
  enabled: true
  replicaCount: 1
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "latest" # Overridden by CI
    pullPolicy: Always
  
  # Connect via External Secrets (The "Tap")
  externalSecrets:
    enabled: true
    # Maps to the Secret created by Terraform in AWS Secrets Manager
    # Naming convention: "${tenant_id}-${env}/database/postgres"
    secretName: "{{ .Values.global.tenant_id }}-{{ .Values.global.env }}/database/postgres"
  
  service:
    type: ClusterIP

  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"

  env:
    JETSCALE_AWS_REGION: "us-east-1"
    # App code must construct DB_URL from the individual secret keys (host, user, pass)

# 3. FRONTEND
frontend-web:
  enabled: true
  image:
    repository: ghcr.io/jetscale-ai/frontend
    tag: "latest" # Overridden by CI
  env:
    # Points to the dynamic Ingress Hostname
    VITE_API_BASE_URL: "https://{{ .Values.global.tenant_id }}.jetscale.ai"

# 4. INGRESS
ingress:
  enabled: true
  className: "alb" # Fulfilled by AWS LB Controller
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
  hosts:
    - host: "{{ .Values.global.tenant_id }}.jetscale.ai"
      paths:
        - path: /
          pathType: Prefix
