# ==========================================================
# PREVIEW ENVIRONMENT (Ephemeral EKS + CI)
# ==========================================================
global:
  env: "preview"

# 1. DATABASE
postgres:
  enabled: true
  # Use Public ECR Mirror (No Rate Limits)
  image: "public.ecr.aws/docker/library/postgres:15-alpine"
  primary:
    persistence:
      enabled: false 
  auth:
    username: "jetscale"
    database: "jetscale"
    password: "ci-password" 

redis:
  enabled: true
  image: "public.ecr.aws/docker/library/redis:7-bullseye"
  architecture: standalone

# 2. BACKEND
backend-api:
  enabled: true
  replicaCount: 1
  imagePullSecrets:
    - name: regcred
  image:
    repository: ghcr.io/jetscale-ai/backend
    tag: "latest"
    pullPolicy: Always
  devMode:
    enabled: false
  service:
    type: ClusterIP
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
  
  # âœ… FIX: Relax probes to prevent premature killing during DB wait
  probes:
    readiness:
      enabled: true
      tcpSocket:
        port: 8000
      initialDelaySeconds: 30
      periodSeconds: 5
      failureThreshold: 30
    liveness:
      enabled: true
      path: "/health"
      port: 8000
      # Give entrypoint.sh 60s to connect to DB before killing the pod
      initialDelaySeconds: 60 
      periodSeconds: 10

  env:
    JETSCALE_DB_HOST: "jetscale-stack-ci-postgres"
    JETSCALE_DB_PORT: "5432"
    JETSCALE_DB_NAME: "jetscale"
    JETSCALE_DB_USER: "jetscale"
    JETSCALE_DB_PASSWORD: "ci-password"
    JETSCALE_DATABASE_URL: "postgresql+asyncpg://jetscale:ci-password@jetscale-stack-ci-postgres:5432/jetscale"
    JETSCALE_REDIS_URL: "redis://jetscale-stack-ci-redis-master:6379/0"

# 3. FRONTEND
frontend-web:
  enabled: true
  imagePullSecrets:
    - name: regcred
  image:
    repository: ghcr.io/jetscale-ai/frontend
    tag: "latest"
  env:
    VITE_API_BASE_URL: "http://jetscale-stack-ci-backend-api:8000"

# 4. INGRESS
ingress:
  enabled: true
  className: "alb"
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
  hosts:
    - host: "preview-placeholder.app.jetscale.ai"
      paths:
        - path: /
          pathType: Prefix
