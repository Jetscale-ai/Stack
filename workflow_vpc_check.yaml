# Add this step before "Generate Terraform Vars" in the ephemeral workflow

- name: Determine VPC Reuse Strategy
  run: |
    set -euo pipefail
    
    ENV_ID="${{ env.ENV_ID }}"
    
    echo "ðŸ” Checking for existing VPC for PR environment: $ENV_ID"
    
    # Check if VPC already exists in AWS
    VPC_EXISTS=$(aws ec2 describe-vpcs \
      --filters "Name=tag:jetscale.env_id,Values=$ENV_ID" \
      --query 'Vpcs[0].VpcId' \
      --output text 2>/dev/null || echo "None")
    
    if [ "$VPC_EXISTS" != "None" ]; then
      echo "âœ… Found existing VPC: $VPC_EXISTS"
      echo "REUSE_VPC=true" >> $GITHUB_ENV
      echo "vpc_reuse_strategy=reuse_existing" >> $GITHUB_OUTPUT
    else
      echo "ðŸ†• No existing VPC found, will create new one"
      echo "REUSE_VPC=false" >> $GITHUB_ENV  
      echo "vpc_reuse_strategy=create_new" >> $GITHUB_OUTPUT
    fi

# Then modify the "Generate Terraform Vars" step:
- name: Generate Terraform Vars
  run: |
    set -euo pipefail
    cat > ephemeral.auto.tfvars.json <<EOF
    {
      "client_name": "${{ env.ENV_ID }}",
      "environment": "ephemeral", 
      "tenant_id": "${{ env.ENV_ID }}",
      "aws_region": "us-east-1",
      "expected_account_id": "134051052096",
      "domain_name": "jetscale.ai",
      "terraform_s3_bucket": "jetscale-terraform-state",
      "cluster_name": "${{ env.ENV_ID }}",
      "kubernetes_namespace": "${{ env.ENV_ID }}",
      "create_dns_records": false,
      "enable_alb_controller": true,
      "enable_external_dns": true,
      "dns_authority_role_arn": "arn:aws:iam::081373342681:role/jetscale-external-dns-dns-authority",
      "acm_certificate_domain": "*.jetscale.ai",
      "enable_deletion_protection": false,
      "enable_nat_gateway": true,
      "reuse_existing_vpc": ${{ env.REUSE_VPC }},
      "tags": {
        "jetscale.env_id": "${{ env.ENV_ID }}",
        "jetscale.lifecycle": "ephemeral",
        "jetscale.created_at": "${{ env.TIMESTAMP }}",
        "jetscale.owner": "${{ github.actor }}"
      }
    }
    EOF
