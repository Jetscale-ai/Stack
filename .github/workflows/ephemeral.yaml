name: "Manual: Ephemeral Env"

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy

permissions:
  contents: read
  id-token: write
  pull-requests: read

jobs:
  manage-env:
    name: "${{ inputs.action }} Ephemeral Env"
    runs-on: ubuntu-latest
    environment: 
      name: preview
      url: https://${{ env.ENV_ID }}.jetscale.ai
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate Env ID
        id: env-id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=$(gh pr view --json number -q .number || echo "")
          if [ -n "$PR_NUM" ]; then
            echo "ENV_ID=pr-${PR_NUM}" >> $GITHUB_ENV
          else
            SAFE_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-20)
            echo "ENV_ID=br-${SAFE_BRANCH}" >> $GITHUB_ENV
          fi

      - name: Checkout Jetscale-IaC
        uses: actions/checkout@v4
        with:
          repository: Jetscale-ai/Jetscale-IaC
          path: iac
          token: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      # DEPLOY
      - name: Terraform Apply
        if: inputs.action == 'deploy'
        working-directory: iac/clients
        run: |
          terraform init \
            -backend-config="bucket=jetscale-terraform-state" \
            -backend-config="key=ephemeral/${{ env.ENV_ID }}/terraform.tfstate" \
            -backend-config="region=us-east-1"
          
          terraform apply -auto-approve \
            -var="client_name=${{ env.ENV_ID }}" \
            -var="environment=preview" \
            -var="tenant_id=${{ env.ENV_ID }}" \
            -var="aws_region=us-east-1" \
            -var="create_dns_records=true"

      - name: Bootstrap & Deploy Stack
        if: inputs.action == 'deploy'
        run: |
          aws eks update-kubeconfig --name ${{ env.ENV_ID }}-preview --region us-east-1
          
          helm repo add eks https://aws.github.io/eks-charts
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update
          
          helm upgrade --install aws-load-balancer-controller eks/aws-load-balancer-controller \
            -n kube-system --set clusterName=${{ env.ENV_ID }}-preview
            
          helm upgrade --install external-secrets external-secrets/external-secrets \
             -n external-secrets --create-namespace

          helm upgrade --install jetscale-stack charts/app \
            --values envs/preview/values.yaml \
            --set global.env=preview \
            --set global.tenant_id=${{ env.ENV_ID }} \
            --wait --timeout 15m

      # DESTROY
      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        working-directory: iac/clients
        run: |
          terraform init \
            -backend-config="bucket=jetscale-terraform-state" \
            -backend-config="key=ephemeral/${{ env.ENV_ID }}/terraform.tfstate" \
            -backend-config="region=us-east-1"

          terraform destroy -auto-approve \
            -var="client_name=${{ env.ENV_ID }}" \
            -var="environment=preview" \
            -var="tenant_id=${{ env.ENV_ID }}" \
            -var="aws_region=us-east-1" \
            -var="create_dns_records=true"
