name: "Ephemeral Review Env"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
        - deploy
        - destroy

permissions:
  contents: read
  id-token: write
  pull-requests: read

jobs:
  manage-env:
    name: "${{ inputs.action || 'deploy' }} Ephemeral Env"
    runs-on: ubuntu-latest
    environment: 
      name: preview
      url: https://${{ env.ENV_ID }}.jetscale.ai
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Calculate Env ID
        id: env-id
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ENV_ID=pr-${{ github.event.number }}" >> $GITHUB_ENV
          else
            SAFE_BRANCH=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | cut -c1-20)
            echo "ENV_ID=br-${SAFE_BRANCH}" >> $GITHUB_ENV
          fi

          # Terraform namespace convention: {client}-{environment}
          echo "K8S_NAMESPACE=${{ env.ENV_ID }}-preview" >> $GITHUB_ENV

      - name: Checkout Jetscale-IaC
        uses: actions/checkout@v4
        with:
          repository: Jetscale-ai/Jetscale-IaC
          path: iac
          token: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      # DEPLOY
      - name: Terraform Apply
        if: github.event_name == 'pull_request' || inputs.action == 'deploy'
        working-directory: iac/clients
        run: |
          terraform init \
            -backend-config="bucket=jetscale-terraform-state" \
            -backend-config="key=ephemeral/${{ env.ENV_ID }}/terraform.tfstate" \
            -backend-config="region=us-east-1"
          
          terraform apply -auto-approve \
            -var="client_name=${{ env.ENV_ID }}" \
            -var="environment=preview" \
            -var="tenant_id=${{ env.ENV_ID }}" \
            -var="aws_region=us-east-1" \
            -var="create_dns_records=false"

      - name: Bootstrap & Deploy Stack
        if: github.event_name == 'pull_request' || inputs.action == 'deploy'
        run: |
          aws eks update-kubeconfig --name ${{ env.ENV_ID }}-preview --region us-east-1

          # Pull private OCI chart deps from GHCR
          echo "${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}" | helm registry login ghcr.io --username jetscalebot --password-stdin
          (cd charts/jetscale && helm dependency build)

          helm upgrade --install jetscale-stack charts/jetscale \
            --namespace "${{ env.K8S_NAMESPACE }}" \
            --create-namespace \
            --values envs/preview/values.yaml \
            --set global.env=preview \
            --set global.client_name=${{ env.ENV_ID }} \
            --set global.tenant_id=${{ env.ENV_ID }} \
            --set frontend-web.env.VITE_API_BASE_URL=https://${{ env.ENV_ID }}.jetscale.ai \
            --set ingress.hosts[0].host=${{ env.ENV_ID }}.jetscale.ai \
            --set backend-api.envFrom[0].secretRef.name=${{ env.ENV_ID }}-db-secret \
            --set backend-api.envFrom[1].secretRef.name=${{ env.ENV_ID }}-redis-secret \
            --set backend-api.envFrom[2].secretRef.name=${{ env.ENV_ID }}-common-secrets \
            --set backend-api.envFrom[3].secretRef.name=${{ env.ENV_ID }}-aws-client-secret \
            --wait --timeout 15m

      # DESTROY
      - name: Terraform Destroy
        if: inputs.action == 'destroy'
        working-directory: iac/clients
        run: |
          terraform init \
            -backend-config="bucket=jetscale-terraform-state" \
            -backend-config="key=ephemeral/${{ env.ENV_ID }}/terraform.tfstate" \
            -backend-config="region=us-east-1"

          terraform destroy -auto-approve \
            -var="client_name=${{ env.ENV_ID }}" \
            -var="environment=preview" \
            -var="tenant_id=${{ env.ENV_ID }}" \
            -var="aws_region=us-east-1" \
            -var="create_dns_records=false"
