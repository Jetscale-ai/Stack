name: "PR Pipeline (Validate > E2E > Preview)"

on:
  pull_request:
    branches: [ main ]
    paths-ignore: [ '**.md', 'docs/**' ]
  repository_dispatch:
    types: [trigger-ci, deploy-preview]
  push:
    branches: [ main ]
    paths-ignore: [ '**.md', 'docs/**' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.client_payload.pr_number || 'stack' }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # STAGE 0: INTEGRITY
  # ============================================================================
  validate:
    name: "0. Validate (Syntax)"
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/jetscale-ai/booster-dev:latest
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - name: Trust Git Directory
        run: git config --global --add safe.directory '*'
      - name: Login to GHCR
        env:
          GH_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
        run: echo "$GH_TOKEN" | helm registry login ghcr.io --username jetscalebot --password-stdin
      - name: Mage Validate
        run: mage validate:envs

  # ============================================================================
  # STAGE 3: SIMULATION (Kind E2E)
  # ============================================================================
  e2e-kind:
    name: "3. E2E (Kind)"
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v4
        with: { go-version: '1.21' }
      
      - name: Install Tools
        run: |
          go install github.com/magefile/mage@latest
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          chmod +x skaffold
          sudo mv skaffold /usr/local/bin
      
      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          version: v0.20.0
          config: kind/kind-config.yaml
          cluster_name: kind
      
      - name: Login to GHCR (Helm CLI)
        env:
          GH_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
        run: echo "$GH_TOKEN" | helm registry login ghcr.io --username jetscalebot --password-stdin

      # üõë CRITICAL FIX: Inject Credentials into the Cluster
      - name: Pre-provision Cluster Secrets
        env:
          GH_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
        run: |
          # 1. Create the namespace used by the 'ci-kind' Skaffold profile
          kubectl create ns jetscale-ci --dry-run=client -o yaml | kubectl apply -f -
          
          # 2. Inject the GHCR credentials so Kubelet can pull images
          kubectl create secret docker-registry regcred \
            --docker-server=ghcr.io \
            --docker-username=jetscalebot \
            --docker-password=$GH_TOKEN \
            --namespace=jetscale-ci \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Run E2E
        run: mage test:ci

  # ============================================================================
  # STAGE 4: PREVIEW (Cloud)
  # ============================================================================
  preview:
    name: "4. Preview (Manual)"
    needs: [e2e-kind]
    if: github.event_name == 'pull_request' || github.event_name == 'repository_dispatch'
    runs-on: ubuntu-latest
    environment: 
      name: preview
      url: https://pr-${{ github.event.client_payload.pr_number || github.event.number }}.app.jetscale.ai

    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v4
        with: { go-version: '1.21' }
      - run: go install github.com/magefile/mage@latest

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy Preview
        env:
          PR_NUMBER: ${{ github.event.client_payload.pr_number || github.event.number }}
        run: |
          if [ -z "$PR_NUMBER" ]; then
            echo "‚ùå Error: Could not determine PR_NUMBER from context."
            exit 1
          fi
          echo "üöÄ Deploying Preview for PR #$PR_NUMBER"
          mage deploy preview
