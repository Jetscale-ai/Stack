name: "CI: Validate & E2E"

on:
  pull_request:
    branches: [main]
    paths-ignore: ['**.md', 'docs/**']
  push:
    branches: [main]
    paths-ignore: ['**.md', 'docs/**']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # STAGE 0: INTEGRITY
  # ============================================================================
  validate:
    name: "CI: Validate"
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/jetscale-ai/booster-dev:latest
      options: --user root
    steps:
      - uses: actions/checkout@v4
      - name: Trust Git Directory
        run: git config --global --add safe.directory '*'
      - name: Login to GHCR
        env:
          BOT_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
        run: echo "$BOT_TOKEN" | helm registry login ghcr.io --username jetscalebot --password-stdin
      - name: Mage Validate
        run: mage validate:envs aws

  # ============================================================================
  # STAGE 3: SIMULATION (Kind E2E)
  # ============================================================================
  e2e-kind:
    name: "CI: E2E (Kind)"
    needs: [validate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v4
        with: {go-version: '1.21'}

      - name: Install Tools
        run: |
          go install github.com/magefile/mage@latest
          curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          chmod +x skaffold
          sudo mv skaffold /usr/local/bin

      - name: Create Kind Cluster
        uses: helm/kind-action@v1
        with:
          version: v0.20.0
          config: kind/kind-config.yaml
          cluster_name: kind

      - name: Login to GHCR (Helm CLI)
        env:
          BOT_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
        run: echo "$BOT_TOKEN" | helm registry login ghcr.io --username jetscalebot --password-stdin

      - name: Pre-provision Cluster Secrets
        env:
          BOT_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
        run: |
          # 1. Namespace
          kubectl create ns jetscale-ci --dry-run=client -o yaml | kubectl apply -f -
          # 2. Secret
          kubectl create secret docker-registry regcred \
            --docker-server=ghcr.io \
            --docker-username=jetscalebot \
            --docker-password=$BOT_TOKEN \
            --namespace=jetscale-ci \
            --dry-run=client -o yaml | kubectl apply -f -
          # 3. ServiceAccount Bind
          kubectl patch serviceaccount default \
            -n jetscale-ci \
            -p '{"imagePullSecrets":[{"name":"regcred"}]}'

      - name: Run E2E
        env:
          # Needed so `mage test:ci` can (idempotently) provision `regcred` for GHCR pulls.
          # Use the same bot token we already used for Helm registry login + pre-provisioning.
          GITHUB_TOKEN: ${{ secrets.JETSCALEBOT_GITHUB_TOKEN }}
          GITHUB_USER: jetscalebot
        run: mage test:ci

      # ‚úÖ Enhanced Debugging (Preserved)
      - name: Debug Failure (Logs & Events)
        if: failure()
        run: |
          echo "üîç ================= DEBUG DIAGNOSTICS ================= üîç"
          echo "1. Cluster Events:"
          kubectl get events -n jetscale-ci --sort-by='.lastTimestamp'

          echo -e "\n2. Pod Status:"
          kubectl get pods -n jetscale-ci -o wide

          echo -e "\n3. Backend API Logs (Current):"
          kubectl logs -n jetscale-ci -l app.kubernetes.io/name=backend-api --tail=200
          echo -e "\n3b. Backend WS Logs (Current):"
          kubectl logs -n jetscale-ci -l app.kubernetes.io/name=backend-ws --tail=200

          echo -e "\n4. Backend API Logs (Previous Crash - If Exists):"
          kubectl logs -n jetscale-ci -l app.kubernetes.io/name=backend-api --previous --tail=200 || echo "No previous instance found."
          echo -e "\n4b. Backend WS Logs (Previous Crash - If Exists):"
          kubectl logs -n jetscale-ci -l app.kubernetes.io/name=backend-ws --previous --tail=200 || echo "No previous instance found."

          echo -e "\n5. Describe Backend API Pod:"
          kubectl describe pods -n jetscale-ci -l app.kubernetes.io/name=backend-api
          echo -e "\n5b. Describe Backend WS Pod:"
          kubectl describe pods -n jetscale-ci -l app.kubernetes.io/name=backend-ws
