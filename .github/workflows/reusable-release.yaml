name: Reusable Chart Release (OCI)

on:
  workflow_call:
    inputs:
      chart_path:
        required: true
        type: string
        description: "Path to the chart directory"
    secrets:
      token:
        required: true
        description: "GitHub Token with packages:write permissions"
    # ‚úÖ NEW: Export the version to the caller
    outputs:
      version:
        description: "The semantic version that was released"
        value: ${{ jobs.release.outputs.version }}

jobs:
  release:
    name: "Release Chart"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    outputs:
      version: ${{ steps.semrel.outputs.version }}

    container:
      image: ghcr.io/jetscale-ai/booster-dev:latest
      options: --user root
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.token }}

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.token }}

      - name: Trust Git Directory
        run: git config --global --add safe.directory '*'

      - name: Semantic Release
        id: semrel
        uses: go-semantic-release/action@v1
        with:
          github-token: ${{ secrets.token }}
          allow-initial-development-versions: true
          force-bump-patch-version: true

      - name: Publish Chart
        if: steps.semrel.outputs.version != ''
        working-directory: ${{ inputs.chart_path }}
        env:
          VERSION: ${{ steps.semrel.outputs.version }}
          REGISTRY: ghcr.io
          OWNER: ${{ github.repository_owner }}
        run: |
          OWNER_LC=$(echo "${OWNER}" | tr '[:upper:]' '[:lower:]')
          OCI_BASE="oci://${REGISTRY}/${OWNER_LC}/charts/"
          
          echo "üöÄ Publishing Version: $VERSION"
          echo "üì¶ OCI Registry: $OCI_BASE"

          # Login (Required for private dependencies)
          echo "${{ secrets.token }}" | helm registry login ${REGISTRY} --username ${{ github.actor }} --password-stdin

          # Version Injection
          yq -i ".version = \"${VERSION}\"" Chart.yaml
          yq -i ".appVersion = \"${VERSION}\"" Chart.yaml

          # Build Dependencies (and regenerate Chart.lock deterministically)
          helm dependency update

          # Package & Push
          helm package .
          helm push *.tgz "${OCI_BASE}"

      - name: Commit & Push Version Bump
        if: steps.semrel.outputs.version != ''
        env:
          VERSION: ${{ steps.semrel.outputs.version }}
          CHART_PATH: ${{ inputs.chart_path }}
        shell: bash
        run: |
          set -euo pipefail

          # Configure Git Identity
          git config --global user.name "jetscale-bot"
          git config --global user.email "bot@jetscale.ai"

          echo "üìù Committing version bump to ${VERSION}..."

          # Stage the modified Chart.yaml (and lockfile if changed)
          git add "${CHART_PATH}/Chart.yaml"
          git add "${CHART_PATH}/Chart.lock" || true

          # Commit with [skip ci] to prevent recursion
          git commit -m "chore(release): v${VERSION} [skip ci]"

          # Push to main
          git push origin HEAD:main
