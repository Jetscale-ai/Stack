name: Reusable Chart Release (OCI)

on:
  workflow_call:
    inputs:
      chart_path:
        required: true
        type: string
        description: "Path to the chart directory (e.g. charts/backend-api)"
      convert_local_deps:
        required: false
        type: boolean
        default: false
        description: "If true, converts file:// dependencies to oci://ghcr.io/OWNER/charts/NAME"
      tag_prefix:
        required: false
        type: string
        default: ""
        description: "Optional prefix for git tags (e.g. 'chart-v') to isolate versioning"
    secrets:
      token:
        required: true
        description: "GitHub Token with contents:write and packages:write permissions"

jobs:
  release:
    name: "Release Chart"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    # âœ… ETHOS: Standardize on the Booster Toolchain
    container:
      image: ghcr.io/jetscale-ai/booster-dev:latest
      options: --user root
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.token }}

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Trust Git Directory
        run: git config --global --add safe.directory '*'

      # 1. Semantic Release
      - name: Semantic Release
        id: semrel
        uses: go-semantic-release/action@v1
        with:
          github-token: ${{ secrets.token }}
          allow-initial-development-versions: true
          force-bump-patch-version: true
          # âœ… NEW: Support for isolated tagging (chart-v1.0.0)
          # Note: If supported by the action, this isolates the release history.
          tag_prefix: ${{ inputs.tag_prefix }}

      # 2. Package & Push
      - name: Publish Chart
        if: steps.semrel.outputs.version != ''
        working-directory: ${{ inputs.chart_path }}
        env:
          VERSION: ${{ steps.semrel.outputs.version }}
          REGISTRY: ghcr.io
          OWNER: ${{ github.repository_owner }}
        run: |
          # 1. Normalize Owner to Lowercase (OCI Requirement)
          # Fixes: invalid repository "Jetscale-ai/..."
          OWNER_LC=$(echo "${OWNER}" | tr '[:upper:]' '[:lower:]')
          OCI_BASE="oci://${REGISTRY}/${OWNER_LC}/charts/"
          
          echo "ðŸš€ Publishing Version: $VERSION"
          echo "ðŸ“¦ OCI Registry: $OCI_BASE"

          # 2. Login
          echo "${{ secrets.token }}" | helm registry login ${REGISTRY} --username ${{ github.actor }} --password-stdin

          # 3. Version Injection
          yq -i ".version = \"${VERSION}\"" Chart.yaml
          yq -i ".appVersion = \"${VERSION}\"" Chart.yaml

          # 4. JIT Dependency Transformation
          if [ "${{ inputs.convert_local_deps }}" = "true" ]; then
             echo "ðŸ”„ Converting file:// dependencies to OCI..."
             yq -i "(.dependencies[] | select(.repository | test(\"^file://\"))) |= .repository = \"${OCI_BASE}\" + .name" Chart.yaml
             cat Chart.yaml
          fi

          # 5. Build Dependencies (Update)
          # Ensures Chart.lock matches the JIT-modified Chart.yaml
          helm dependency update

          # 6. Package & Push
          helm package .
          helm push *.tgz "${OCI_BASE}"
